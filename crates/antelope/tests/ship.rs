use antelope::chain::Packer;
use antelope::util::{bytes_to_hex, hex_to_bytes};
use crate::utils::ship_types::{ActionTrace, TransactionTrace};

mod utils;

// TODO: This is for testing a non-utf8 string, https://github.com/telosnetwork/antelope-rs/issues/42
// #[test]
fn traces() {
    let traces_hex = "0200c102e4e7f45c22323866e70a1e8b8ed73b05b16794e7fd1131b8ddc6dc5a5b1600640000000023000000000000000000000000000000000100010001000000000000ea30550d4df2b79268435c5cbe6128162e6ce581365fe3a2c89963d22811e56f3edc5e47bafa0600000000cf2fdf0500000000010000000000ea30555415f905000000001d0c0000000000ea30550000000000ea305500000000221acfa4010000000000ea305500000000a8ed323274237da84fa02a4598469555cb000005c62bf306cd4d70588d704e9ba8c23fb157b4747fdbf2d76ed229793be85c3d227a3905afb6394fea8cf71c5f5b35db02d49297339bc4c3632750434a534720577f8a2bf23ff615a7dd813e916dc454d5a18f7e83b1e79b44796ff528fcbfde673200000000001900000000000000000000000000000001000000000000000000000000000000000000fb12f424fc903ef5f7d5e93b118c3bdd2eb18eb397d0760d436d73bdafc7cb330092060000c302ad00000000000000180a00000000000000020001000100103256396395d7dd149c567f7683a25a4c92acad3a1c792c667e4cefea6f4e30320dd622e713244748bafa06000000000e0000000000000001103256396395d7dd0f000000000000000101103256396395d7dd103256396395d7dd000000204d73b3c201103256396395d7dd00000000a8ed3232b71307000000000000001032be2a4683d6dd052863c20500000000423078303563323633323837323663356561666631653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539341e000000000000004c343435393437343835303737383937373737343830393931353330343433393732383336303632323633323030323830353937353133343935343032353632393135323235383331363733372c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c45474e4d52385450576a5549486335346b776e31703468426d42563556413847664c6e566f554856754659424d36313032333233343431363835343137353538373534343131313938373830393232303230373733363132393234323232343037303631393030343931333836323539353436373038343836344e3130333633313334313339353434313734333634383136373935393432313337343939303136303839373439353938323738353933343038373935323836313936343239313637363538383238394d3936303737363332353437383037303937303838353039363333323039363538303735393933363531383236393733323538333736333135383133363333393339383338383239323731383332733debe54f036ad42863c20500000000423078303563323633323837323663356561666631653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539342c010000000000004e3131313637383235353738373436323638333932363739333235343231393135393438383834373138323634383237353033303338323738373638383936303538303838363231373432373130392c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c6c5067635a4e3442676a2b48676c37677931637661574a776f63796365384236614e39622f7050556b576f414d35353734373333393530303131383934373439383137353839373333393239353535323735343136313338383639343931383037313438373531323439333530363237303634393339343439314e3130353438363437363233363839343539343537393733353335323734343534313434333035393636303233333535303732303739383432393839373130383335363039323630313638333538354e3130363237363333313435333035333634333236363433393331353131313337343530373734333439363630363835313935373037393639343833383131363334373633343237343739323233322e354bfb9e45f6ea2863c2050000000042307830356332363332383732366335656166663165363733636537633232393266613763383461343761306230633535333233363165623337306638656230653934b80b0000000000004d39393035313830353532373136343437323934343338353134383836323230363437323439323532363031313034323732393034313332313530373839323938383139383938323339383432382c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c543045525a473130575151304b44623067505756696b4a34755a6b70654a4f54456272334a4639726c4e38414d32363435333139343336373530323633393931333731363730373837363632383935343239313336343431363533313438343231303736353236373430363239373437353838333632393835374c383338313132383630373733373234353436383436393934333731363036383735303533393236313539313435363337383435353138393535363738333230393936343535303232333139304d3336363334383839343936373234393633323533303031323734393433333937383537323433333738373337343637323232353733363330373238363735393432373031363933383839353931e7739382d69cfe502863c205000000004230783035633236333238373236633565616666316536373363653763323239326661376338346134376130623063353533323336316562333730663865623065393430750000000000004d39373339373533343236353636313934313931303132373639303839363234373830393335313533373131393733363035363530373731393836343634353333303037343833393034393936352c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c534a564b5671466b3762574265784b4e716a7639786d504f4a3663346d644f6446624d4a76366234507241414e3130363833343230313331353635383934313936393739323735363332303736303638383531393037303130333536343131373333323638373636343838343036303836343634383738383831344e3130343432343832303332333635373735353238393838363031363039323330393130363833373838323539303037363331333735383438353035343730343133333935363130323730363734314d3631383239323738363432353331323338333830373133313839323633303036393432303837323432323634393433373734343932393635313835383534313431343030343034363832303937e4649d55ae21b2882863c2050000000042307830356332363332383732366335656166663165363733636537633232393266613763383461343761306230633535333233363165623337306638656230653934e0930400000000004d32323336353732353634353138333632323232333935323239363137363533343839333132343036303933373034353935383937333638343037373739333939323330383435343031363633302c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c4c4235472b55385263347a626d613457447a586e51716e354f464b474f494535586e6f5833415264446a38424d36333535383435353132363236303531343236313335353037313639323536363634323535323734313534373133373435333331373030363431373331343535313732383338313930343130314e3131323939363530333739323738343639333734303939363237373738333734353936323531303237343733313333393437363635383130303630303638363638383134353931363832323230394d3738303338343634373433303637333934333237333734303638323936333632343430353537333234363533323038303834363732343539303732383937373938353839313034333032303133254de226ae3488ac001b000000000000000000000000020101001032be2a4683d6dd09dba32847eb6b741ba0bc60f872731bcd48864af6b43c44f2e62f3f39e4e61749bafa0600000000080000000000000001103256396395d7dd100000000000000001011032be2a4683d6dd1032be2a4683d6dd00d234576da790ba01103256396395d7dd00000000a8ed3232ac0e0700000000000000052863c20500000000423078303563323633323837323663356561666631653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539341e000000000000004c343435393437343835303737383937373737343830393931353330343433393732383336303632323633323030323830353937353133343935343032353632393135323235383331363733372c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c45474e4d52385450576a5549486335346b776e31703468426d42563556413847664c6e566f554856754659424d36313032333233343431363835343137353538373534343131313938373830393232303230373733363132393234323232343037303631393030343931333836323539353436373038343836344e3130333633313334313339353434313734333634383136373935393432313337343939303136303839373439353938323738353933343038373935323836313936343239313637363538383238394d3936303737363332353437383037303937303838353039363333323039363538303735393933363531383236393733323538333736333135383133363333393339383338383239323731383332733debe54f036ad42863c20500000000423078303563323633323837323663356561666631653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539342c010000000000004e3131313637383235353738373436323638333932363739333235343231393135393438383834373138323634383237353033303338323738373638383936303538303838363231373432373130392c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c6c5067635a4e3442676a2b48676c37677931637661574a776f63796365384236614e39622f7050556b576f414d35353734373333393530303131383934373439383137353839373333393239353535323735343136313338383639343931383037313438373531323439333530363237303634393339343439314e3130353438363437363233363839343539343537393733353335323734343534313434333035393636303233333535303732303739383432393839373130383335363039323630313638333538354e3130363237363333313435333035333634333236363433393331353131313337343530373734333439363630363835313935373037393639343833383131363334373633343237343739323233322e354bfb9e45f6ea2863c2050000000042307830356332363332383732366335656166663165363733636537633232393266613763383461343761306230633535333233363165623337306638656230653934b80b0000000000004d39393035313830353532373136343437323934343338353134383836323230363437323439323532363031313034323732393034313332313530373839323938383139383938323339383432382c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c543045525a473130575151304b44623067505756696b4a34755a6b70654a4f54456272334a4639726c4e38414d32363435333139343336373530323633393931333731363730373837363632383935343239313336343431363533313438343231303736353236373430363239373437353838333632393835374c383338313132383630373733373234353436383436393934333731363036383735303533393236313539313435363337383435353138393535363738333230393936343535303232333139304d3336363334383839343936373234393633323533303031323734393433333937383537323433333738373337343637323232353733363330373238363735393432373031363933383839353931e7739382d69cfe502863c205000000004230783035633236333238373236633565616666316536373363653763323239326661376338346134376130623063353533323336316562333730663865623065393430750000000000004d39373339373533343236353636313934313931303132373639303839363234373830393335313533373131393733363035363530373731393836343634353333303037343833393034393936352c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c534a564b5671466b3762574265784b4e716a7639786d504f4a3663346d644f6446624d4a76366234507241414e3130363833343230313331353635383934313936393739323735363332303736303638383531393037303130333536343131373333323638373636343838343036303836343634383738383831344e313034343234383230333233363537005100000000000000fc145265636569766572616e642063616c6c65642077697468206173736f635f69643a203720616e642070726f6f66733a205b200a5b0a426c6f636b204e756d3a2039363632353434380a426c6f636b2049643a20343233303738333033353633333233363333333233383337333233363633333536353631363636363331363533363337333336333635333736333332333233390a536565643a20373030343238353331393235303031313639380a46696e616c20536565643a2037613062306335353332333631656233373066386562306539341e000000000000004c34343539343734383530373738393737370a5075626c6963204b65793a20343830393931353330343433393732383336303632323633323030323830353937353133343935343032353632393135323235383331360a47616d6d613a2033372c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c45474e4d5238540a433a20576a5549486335346b776e31703468426d42563556413847664c6e566f554856754659424d363130323332333434313638353431373535383735343431313139383738303932323032303737333631320a533a203234323232343037303631393030343931333836323539353436373038343836344e31303336333133343133393534343137343336343831360a4f757470757420553235363a203935393432313337343939303136303839373439353938323738353933343038373935323836313936343239313637363538383238394d0a4f7574707574205536343a20333631373239343533363438353634373932390a5d0a0a5b0a426c6f636b204e756d3a20343132303835343333393238353130333636390a426c6f636b2049643a20333733303338333833353330333933363333333333323330333933363335333833303337333533393339333333363335333133383332333633393337333333320a536565643a20333833323930313036353831363335363931370a46696e616c20536565643a203133363333393339383338383239323731383332733debe54f036ad42863c2050000000042307830356332363332383732366335656166660a5075626c6963204b65793a20653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539342c01000a47616d6d613a200a433a200a533a200a4f757470757420553235363a200a4f7574707574205536343a20343035303736353937343734393636323732300a5d0a0a5b0a426c6f636b204e756d3a20333930353830373439313432303939323831380a426c6f636b2049643a20333233363338333333393332333633373339333333323335333433323331333933313335333933343338333833383334333733313338333233363334333833320a536565643a20333631383639383538323730323433373638370a46696e616c20536565643a2038373638383936303538303838363231373432373130392c353170492b735a41544d4753706c71652b7344353853434b3847536378505a0a5075626c6963204b65793a20656e6d684a364430346951412c6c5067635a4e3442676a2b48676c37677931637661574a776f63796365384236614e39622f7050556b576f414d353537343733330a47616d6d613a203530303131383934373439383137353839373333393239353535323735343136313338383639343931383037313438373531323439333530360a433a2037303634393339343439314e31303534383634373632333638393435393435373937333533353237343435343134343330350a533a203636303233333535303732303739383432393839373130383335363039323630313638333538354e31303632373633333134353330353336340a4f757470757420553235363a203236363433393331353131313337343530373734333439363630363835313935373037393639343833383131363334373633340a4f7574707574205536343a20333638393036363236363039303535313039300a5d0a0a5b0a426c6f636b204e756d3a2031373734353736343730383835393036333835380a426c6f636b2049643a20656132383633633230353030303030303030343233303738333033353633333233363333333233383337333233363633333536353631363636363331363533360a536565643a20333631373036323534303330373238303639350a46696e616c20536565643a203266613763383461343761306230633535333233363165623337306638656230653934b80b0000000000004d393930353138303535323731360a5075626c6963204b65793a20343732393434333835313438383632323036343732343932353236303131303432373239303431333231353037383932393838310a47616d6d613a20383938323339383432382c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c540a433a2045525a473130575151304b44623067505756696b4a34755a6b70654a4f54456272334a4639726c4e38414d32363435330a533a20393433363735303236333939313337313637303738373636323839353432393133363434313635333134383432313037360a4f757470757420553235363a203236373430363239373437353838333632393835374c383338313132383630373733373234353436383436393934333731363036380a4f7574707574205536343a20333930353234363731383938323130383437310a5d0a0a5b0a426c6f636b204e756d3a20333639303139353434323935373130343433330a426c6f636b2049643a20333733383334333533353331333833393335333533363337333833333332333033393339333633343335333533303332333233333331333933303464333333360a536565643a20343132313938323437323537343734333335300a46696e616c20536565643a203732343936333235333030313237343934333339373835373234333337383733373436373232323537333633303732383637353934320a5075626c6963204b65793a203031363933383839353931e7739382d69cfe502863c20500000000423078303563323633323837323663356561666631653637336365370a47616d6d613a20323239326661376338346134376130623063353533323336316562333730663865623065393430750000000000004d393733393735333432363536363139343139313031323736393038393632343738303933353135333731313937333630353635300a433a203731393836343634353333303037343833393034393936352c353170492b735a41544d4753706c71652b7344353853434b3847536378500a533a2041656e6d684a364430346951412c534a564b5671466b3762574265784b4e716a7639786d504f4a3663346d644f6446624d4a76366234507241414e313036383334323031333135363538393431393639373932373536333230370a4f757470757420553235363a20303638383531393037303130333536343131373333323638373636343838343036303836343634383738383831344e313034343234380a4f7574707574205536343a20333937383134353433393336353134383732320a5d0a5d0a0000000000000001002f824160f12b240f721f0000000001001f2af7e31e8db27032244eff7429f13958442636938873ddfe08bcbbe9fb45b7e318ab74b78e89166a6c67ad506e01730d964f1017ea23b4f591e50cc9500fe7c400";
    let console_hex = "5265636569766572616e642063616c6c65642077697468206173736f635f69643a203720616e642070726f6f66733a205b200a5b0a426c6f636b204e756d3a2039363632353434380a426c6f636b2049643a20343233303738333033353633333233363333333233383337333233363633333536353631363636363331363533363337333336333635333736333332333233390a536565643a20373030343238353331393235303031313639380a46696e616c20536565643a2037613062306335353332333631656233373066386562306539341e000000000000004c34343539343734383530373738393737370a5075626c6963204b65793a20343830393931353330343433393732383336303632323633323030323830353937353133343935343032353632393135323235383331360a47616d6d613a2033372c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c45474e4d5238540a433a20576a5549486335346b776e31703468426d42563556413847664c6e566f554856754659424d363130323332333434313638353431373535383735343431313139383738303932323032303737333631320a533a203234323232343037303631393030343931333836323539353436373038343836344e31303336333133343133393534343137343336343831360a4f757470757420553235363a203935393432313337343939303136303839373439353938323738353933343038373935323836313936343239313637363538383238394d0a4f7574707574205536343a20333631373239343533363438353634373932390a5d0a0a5b0a426c6f636b204e756d3a20343132303835343333393238353130333636390a426c6f636b2049643a20333733303338333833353330333933363333333333323330333933363335333833303337333533393339333333363335333133383332333633393337333333320a536565643a20333833323930313036353831363335363931370a46696e616c20536565643a203133363333393339383338383239323731383332733debe54f036ad42863c2050000000042307830356332363332383732366335656166660a5075626c6963204b65793a20653637336365376332323932666137633834613437613062306335353332333631656233373066386562306539342c01000a47616d6d613a200a433a200a533a200a4f757470757420553235363a200a4f7574707574205536343a20343035303736353937343734393636323732300a5d0a0a5b0a426c6f636b204e756d3a20333930353830373439313432303939323831380a426c6f636b2049643a20333233363338333333393332333633373339333333323335333433323331333933313335333933343338333833383334333733313338333233363334333833320a536565643a20333631383639383538323730323433373638370a46696e616c20536565643a2038373638383936303538303838363231373432373130392c353170492b735a41544d4753706c71652b7344353853434b3847536378505a0a5075626c6963204b65793a20656e6d684a364430346951412c6c5067635a4e3442676a2b48676c37677931637661574a776f63796365384236614e39622f7050556b576f414d353537343733330a47616d6d613a203530303131383934373439383137353839373333393239353535323735343136313338383639343931383037313438373531323439333530360a433a2037303634393339343439314e31303534383634373632333638393435393435373937333533353237343435343134343330350a533a203636303233333535303732303739383432393839373130383335363039323630313638333538354e31303632373633333134353330353336340a4f757470757420553235363a203236363433393331353131313337343530373734333439363630363835313935373037393639343833383131363334373633340a4f7574707574205536343a20333638393036363236363039303535313039300a5d0a0a5b0a426c6f636b204e756d3a2031373734353736343730383835393036333835380a426c6f636b2049643a20656132383633633230353030303030303030343233303738333033353633333233363333333233383337333233363633333536353631363636363331363533360a536565643a20333631373036323534303330373238303639350a46696e616c20536565643a203266613763383461343761306230633535333233363165623337306638656230653934b80b0000000000004d393930353138303535323731360a5075626c6963204b65793a20343732393434333835313438383632323036343732343932353236303131303432373239303431333231353037383932393838310a47616d6d613a20383938323339383432382c353170492b735a41544d4753706c71652b7344353853434b3847536378505a41656e6d684a364430346951412c540a433a2045525a473130575151304b44623067505756696b4a34755a6b70654a4f54456272334a4639726c4e38414d32363435330a533a20393433363735303236333939313337313637303738373636323839353432393133363434313635333134383432313037360a4f757470757420553235363a203236373430363239373437353838333632393835374c383338313132383630373733373234353436383436393934333731363036380a4f7574707574205536343a20333930353234363731383938323130383437310a5d0a0a5b0a426c6f636b204e756d3a20333639303139353434323935373130343433330a426c6f636b2049643a20333733383334333533353331333833393335333533363337333833333332333033393339333633343335333533303332333233333331333933303464333333360a536565643a20343132313938323437323537343734333335300a46696e616c20536565643a203732343936333235333030313237343934333339373835373234333337383733373436373232323537333633303732383637353934320a5075626c6963204b65793a203031363933383839353931e7739382d69cfe502863c20500000000423078303563323633323837323663356561666631653637336365370a47616d6d613a20323239326661376338346134376130623063353533323336316562333730663865623065393430750000000000004d393733393735333432363536363139343139313031323736393038393632343738303933353135333731313937333630353635300a433a203731393836343634353333303037343833393034393936352c353170492b735a41544d4753706c71652b7344353853434b3847536378500a533a2041656e6d684a364430346951412c534a564b5671466b3762574265784b4e716a7639786d504f4a3663346d644f6446624d4a76366234507241414e313036383334323031333135363538393431393639373932373536333230370a4f757470757420553235363a20303638383531393037303130333536343131373333323638373636343838343036303836343634383738383831344e313034343234380a4f7574707574205536343a20333937383134353433393336353134383732320a5d0a5d0a";
    let traces = hex_to_bytes(traces_hex);
    let block_traces: Vec<TransactionTrace> = decode(traces.as_slice());
    for trace in block_traces {
        match trace {
            TransactionTrace::V0(trace) => {
                for action in trace.action_traces {
                    match action {
                        ActionTrace::V0(action) => {
                            if action.console.len() > 0 {
                                assert_eq!(bytes_to_hex(&action.console), console_hex);
                            }
                        }
                        ActionTrace::V1(action) => {
                            if action.console.len() > 0 {
                                assert_eq!(bytes_to_hex(&action.console), console_hex);
                            }
                        }
                    }
                }
            }
        }
    }
}

fn decode<T: Packer + Default>(raw: &[u8]) -> T {
    let mut result = T::default();
    result.unpack(raw);
    result
}